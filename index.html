<!doctype html>
<html>
<style type="text/css">

h1, form
{
	text-align: center;
}

/*table 
{
	font-family: arial, sans-serif;
	border-collapse: collapse;
}

td, th 
{
	border: 1px solid #dddddd;
	text-align: left;
	padding: 8px;
}*/

table {
  border-collapse: collapse;
  margin: auto;
  /*width: 100%;*/
  color: red;
}

th, td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

tr:hover {background-color:#f5f5f5;}

th
{
	background-color: white !important;
}

th:hover
{
	cursor: pointer;
}

/*tr:nth-child(even) 
{
	background-color: #eeeeee;
}*/

.chart
{
	margin: auto;
	width: 500px;
	height: 300px;
	margin-bottom: 30px;
	display: inline-block;
}

</style>
<head>
	<title>COVID-19 Live Statistics</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link href="https://fonts.googleapis.com/css?family=Manrope:200,400,700,800&display=swap" rel="stylesheet">
	<meta charset="utf-8"/>
	<script>

		var history_arr = [];

		function getData() 
		{
 			request = new XMLHttpRequest();
			request.open("GET", "https://covidtracking.com/api/states/daily");
			request.onreadystatechange = function() 
			{
				if (request.readyState == 4 && request.status == 200) 
				{
					result = request.responseText;
					data = JSON.parse(result);

					text = "<table id='table'><tr><th><input onchange='update_all_checkboxes()' type='checkbox' name='row'/></th><th onClick='sortBy(1)'>&#9660; State</th><th onClick='sortBy(2)'>&#9661; Total Positive Cases</th><th onClick='sortBy(3)'>&#9661; Daily Positive Increase</th><th onClick='sortBy(4)'>&#9661; Total Deaths</th><th onClick='sortBy(5)'>&#9661; Daily Death Increase</th></tr>";

					for (i = 0; i < 56; i++) 
					{
						if (data[i]["state"] !== "AS") {
							text += "<tr><td><input onchange='update_visuals()' type='checkbox' name='row'/></td><td>" + data[i]["state"] + "</td><td>" + data[i]["positive"] + "</td><td>" + data[i]["positiveIncrease"] + "</td><td>" + data[i]["death"] + "</td><td>" + data[i]["deathIncrease"] + "</td></tr>";
						}

					}

					text += "</table>";

					document.getElementById("data").innerHTML = text;

					history_arr["Total Positive Cases"] = set_history_array("positive", data);
					history_arr["Daily Positive Case Increase"] = set_history_array("positiveIncrease", data);
					history_arr["Total Deaths"] = set_history_array("death", data);
					history_arr["Daily Death Increase"] = set_history_array("deathIncrease", data);
				}
			}

			request.send();

			anychart.onDocumentReady(function()
	        {
				var chart = anychart.column();
				chart.title("Selected states below to see them here.");
				chart.xAxis().title("States");
    			chart.yAxis().title("Total Positive Cases");
				chart.container("container");
				chart.draw();

				var chart2 = anychart.line();
				chart2.title("Selected states below to see them here.");
				chart2.xAxis().title("Time");
    			chart2.yAxis().title("Total Positive Cases");
    			chart2.container("container2");
				chart2.draw();
			});
		}

		function set_history_array(str, data)
		{
			var arr = new Array(55);
			var text = null;
			for (i = 0; i < 56; i++) {
				if (data[i]["state"] !== "AS"){
					arr[data[i]["state"]] = new Array(30);
					text += data[i]["state"] + ": ";
					var set = i;
					for (j = 0; j < 30; j++) {
						arr[data[i]["state"]][j] = data[set][str];
						text += data[set][str] + ", ";
						set = set + 56; 
					}
					text += "<br>";
				}
			}
			// do sth with text also?
			return arr;
		}

		function update_all_checkboxes()
		{
			table = document.getElementById("table");
			rows = table.rows;

			value = rows[0].getElementsByTagName("TH")[0].getElementsByTagName("input")[0].checked;
			
			for (i = 1; i < rows.length; i++) 
			{
				rows[i].getElementsByTagName("TD")[0].getElementsByTagName("input")[0].checked = value;
			}

			update_chart();
			update_plot();
		}
		
		var sorted_by_index = 1;
		var descending = true;

		function sortBy(index)
		{
			var table, rows, switching, i, x, y, shouldSwitch;
			table = document.getElementById("table");
			switching = true;

			if (index == sorted_by_index) descending = !descending;
			else descending = true;

			fix_table(sorted_by_index, index);
			sorted_by_index = index;

			while (switching) 
			{
				switching = false;
				rows = table.rows;

				for (i = 1; i < (rows.length - 1); i++) 
				{
					shouldSwitch = false;

					x = rows[i].getElementsByTagName("TD")[sorted_by_index].innerHTML;
					y = rows[i + 1].getElementsByTagName("TD")[sorted_by_index].innerHTML;

					if (sorted_by_index == 1)
					{
						if (descending) comparison = x > y;
						else comparison = x < y;
					}
					else
					{
						x = parseInt(x);
						y = parseInt(y);
						if (descending) comparison = x < y;
						else comparison = x > y;
					}

					if (comparison)
					{
						shouldSwitch = true;
						break;
					}
					
				}
				if (shouldSwitch) 
				{
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
					switching = true;
				}
			}	 
		}

		function fix_table(old_i, new_i)
		{
			old_str = document.getElementById("table").rows[0].getElementsByTagName("TH")[old_i].innerHTML;

			if (old_i == new_i)
			{
				if (descending) document.getElementById("table").rows[0].getElementsByTagName("TH")[old_i].innerHTML = "&#9660;" + old_str.substring(1);
				else document.getElementById("table").rows[0].getElementsByTagName("TH")[old_i].innerHTML = "&#9650;" + old_str.substring(1);
			}
			else
			{
				new_str = document.getElementById("table").rows[0].getElementsByTagName("TH")[new_i].innerHTML;

				document.getElementById("table").rows[0].getElementsByTagName("TH")[old_i].innerHTML = "&#9661;" + old_str.substring(1);
				document.getElementById("table").rows[0].getElementsByTagName("TH")[new_i].innerHTML = "&#9660;" + new_str.substring(1);
			}
			
		}

		var colors = ["blue", "green", "orange", "red", "black", "purple", "brown"]

		function update_visuals()
		{
			update_chart();
			update_plot();
		}

		function update_chart()
		{
			arr = [];
			document.getElementById("container").innerHTML = "";
			table = document.getElementById("table");
			rows = table.rows;
			dropdown = document.getElementById("sort");

			for (i = 1; i < rows.length; i++) 
			{
				if (rows[i].getElementsByTagName("TD")[0].getElementsByTagName("input")[0].checked)
				{
					state_name = rows[i].getElementsByTagName("TD")[1].innerHTML;
					stat = parseInt(rows[i].getElementsByTagName("TD")[dropdown.selectedIndex+2].innerHTML);
					arr.push ([state_name, stat]);
				}
			}

	        anychart.onDocumentReady(function() 
	        {
			    var data = { rows: arr };

				var chart = anychart.column();
				
				chart.data(data);

				selected = dropdown.options[dropdown.selectedIndex].value;
				chart.title(selected + " in Selected States");
				chart.xAxis().title("States");
    			chart.yAxis().title(selected);

				chart.container("container");
				chart.draw();
			});
	    }

	    function update_plot()
		{
			arr = [];
			document.getElementById("container2").innerHTML = "";
			dropdown = document.getElementById("sort");
			selected = dropdown.options[dropdown.selectedIndex].value;
			num_checked = 0;

			for (j = 0; j < history_arr[selected]["AK"].length; j++) arr.push([j]);

			for (i = 1; i < rows.length; i++) 
			{
				if (rows[i].getElementsByTagName("TD")[0].getElementsByTagName("input")[0].checked)
				{
					state_name = rows[i].getElementsByTagName("TD")[1].innerHTML;
					for (j = 0; j < history_arr[selected][state_name].length; j++)
					{
						arr[j].push([history_arr[selected][state_name][j]]);
					}
					num_checked++;
				}
			}

	        anychart.onDocumentReady(function() 
	        {
			    var data = anychart.data.set (arr.reverse());

				var chart = anychart.line();

				for (i = 0; i < num_checked; i++)
					chart.line(data.mapAs({x: 0, value: i+1})).name("AK");

				chart.title(selected + " in Selected States");
				chart.xAxis().title("Time");
    			chart.yAxis().title(selected);

				chart.container("container2");
				chart.draw();
			});
	    }
	

	</script>
	<script   src="https://code.jquery.com/jquery-3.4.1.js"   integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="   crossorigin="anonymous"></script>
</head>
<body onload="getData()">
	<h1>COVID-19 LIVE STATISTICS</h1>

<!-- 	<nav style="z-index: 100">
		<div class="nav">
			<ul>
				<li><a class="current" href="#">Home</a></li>
				<li><a href="donations.html">Donate Masks</a></li>

		</ul>
		</div>
	</nav> -->

	<!-- <h3 style="margin-bottom: 5px">Graph: </h3> -->
	<form style="margin-bottom:20px">
		<select id="sort" onchange="update_visuals()">
			<option>Total Positive Cases</option>
			<option>Daily Positive Case Increase</option>
			<option>Total Deaths</option>
			<option>Daily Death Increase</option>
		</select>
	</form>

	<script src="https://cdn.anychart.com/releases/8.0.0/js/anychart-base.min.js"></script>
	<div class=chart id="container"></div>
	<div class=chart id="container2"></div>

	<div id="blah"></div>

	<div id="data"></div>


<!------------------------- floating TOP button ----------------------------->
<button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>
<script type="text/javascript">
	
	btn_top = document.getElementById("myBtn");


	window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    btn_top.style.display = "block";
  } else {
    btn_top.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}
</script>
<!--------------------- end of floating TOP button --------------------------->


<footer>
	<div>
		&copy; Team Webalubadubdub, 2020
	</div>
</footer>

</body>
</html>